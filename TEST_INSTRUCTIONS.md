# テスト実行ガイド

## 修正内容

以下のテストエラーを修正しました：

### 1. システムプロンプト取得テスト ✅
- **問題**: プロンプトセルの位置が異なっていた
- **修正**: `A1` から `B5` (CONFIG.SHEETS.SYSTEM_PROMPT_CELL) に変更

### 2. ログ記録テスト ✅  
- **問題**: 存在しない関数 `logToSheet` を呼び出していた
- **修正**: メインコードの `logChat` 関数を使用するように変更
- **追加修正**: ヘッダー行を考慮した行番号チェックを追加

### 3. キャッシュ機能テスト ✅
- **問題**: キャッシュの履歴構造が異なっていた
- **修正**: 
  - `saveConversationHistory` は履歴オブジェクト全体を受け取る
  - 履歴は `{userId: [messages]}` の形式
  - メッセージは `{role, parts: [{text}]}` の形式

### 4. メッセージ処理統合テスト ✅
- **問題**: 履歴の初期化処理が異なっていた
- **修正**: メインコードの `processMessage` が自動的に履歴を管理

## テスト実行方法

### 前提条件
1. Google Apps Script エディタを開く
2. `test-framework.js` をプロジェクトに追加
3. スクリプトプロパティに `apikey` を設定

### 実行手順

```javascript
// 1. Google Apps Script エディタで以下を実行：

// 全テストを実行
runAllTests()

// または個別にテストを実行
setupTestEnvironment()     // 環境セットアップ
testGetApiKey()            // APIキー取得テスト
testGetSystemPrompt()      // プロンプト取得テスト  
testLogging()              // ログ記録テスト
testCaching()              // キャッシュ機能テスト
testProcessMessage()       // メッセージ処理統合テスト
```

### 負荷テストの実行

```javascript
// 複数ユーザーと複数メッセージでの負荷テスト
loadTest()
```

## テスト結果の確認

テスト結果は以下の場所で確認できます：

1. **Google Apps Script コンソール**: リアルタイムログ出力
2. **スプレッドシート「テスト結果」シート**: 各テストの実行結果が記録される
   - 実行日時
   - テスト名
   - 結果（✅ PASS / ❌ FAIL）
   - 実行時間（ms）
   - エラー内容（失敗時）
   - 詳細情報

## 期待される結果

すべてのテストが成功すると：
```
📊 テスト結果サマリー:
✅ 成功: 6
❌ 失敗: 0
⏱️ 総実行時間: [実行時間]ms
```

## トラブルシューティング

### APIキー取得テスト失敗
- スクリプトプロパティに `apikey` が設定されているか確認
- プロパティ名が正確に `apikey`（小文字）であることを確認

### プロンプト取得テスト失敗  
- 「プロンプト」シートが存在するか確認
- B5セルにプロンプトテキストが入力されているか確認

### ログ記録テスト失敗
- 「ログ」シートへの書き込み権限があるか確認
- シートが保護されていないか確認

### キャッシュ機能テスト失敗
- キャッシュサービスが有効か確認
- スクリプトの実行時間制限に達していないか確認

### メッセージ処理統合テスト失敗
- Gemini APIキーが有効か確認
- APIの呼び出し制限に達していないか確認
- ネットワーク接続を確認

## 注意事項

- テスト実行時はGemini APIを実際に呼び出すため、API利用料が発生する可能性があります
- 負荷テストは多数のAPI呼び出しを行うため、慎重に実行してください
- テストデータはスプレッドシートに蓄積されるため、定期的にクリーンアップすることを推奨します