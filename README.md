# Gemini AIチャットボット for Google Apps Script

LINE風のUIを持つ高機能なGemini AI搭載チャットボットアプリケーション。Google Apps ScriptとGoogle Sheetsを使用して構築された、エンタープライズレベルの機能を持つチャットシステムです。

## 🌟 主な機能

### 🎨 ユーザーインターフェース
- **LINE風UI**: モバイルファーストのレスポンシブデザイン
- **8種類のテーマ**: デフォルト、ダーク、サンセット、フォレスト、オーシャン、ラベンダー、ミッドナイト、さくら、カスタム
- **4段階の文字サイズ**: 小・中・大・特大の調整可能
- **カスタマイズ可能**: 色、フォント、レイアウトの詳細設定

### 🤖 AI機能
- **Gemini AI統合**: Google Gemini 2.5 Flashモデルを使用
- **高度な会話管理**: 6時間のキャッシュ保持、最大10メッセージの履歴
- **コンテキスト保持**: 長時間の会話における文脈の維持
- **システムプロンプト**: カスタマイズ可能なAI応答スタイル

### 📊 データ管理・ログ記録
- **完全な会話ログ**: Google Sheetsへの詳細なログ記録
- **バッチ処理**: 効率的なログ保存システム（10件ごとのバッチ処理）
- **エクスポート機能**: CSV、JSON、テキスト形式での会話データエクスポート
- **統計情報**: 使用状況、パフォーマンス指標の詳細分析

### ⚡ パフォーマンス最適化
- **3層ストレージアーキテクチャ**: メモリバッファ → キャッシュサービス → Google Sheets
- **インテリジェントキャッシュ**: プロンプト・設定・APIキーのキャッシュ機能
- **並行処理制御**: 最大5件の同時リクエスト処理
- **自動リトライ**: 指数バックオフによる堅牢なエラー回復

### 🔧 管理機能
- **包括的な管理メニュー**: 統計、ヘルスチェック、データ管理
- **セッション管理**: 高度なユーザーセッション追跡とエクスポート/インポート
- **システムヘルスチェック**: リアルタイムの健全性監視
- **アクティブユーザー管理**: 現在のユーザー状況の可視化

### 🛡️ セキュリティ・信頼性
- **エラーハンドリング**: 包括的な例外処理と日本語エラーメッセージ
- **レート制限対応**: 429/503エラーの自動回復
- **データ整合性**: 自動バックアップと復元機能
- **セキュアな認証**: スクリプトプロパティによるAPIキー管理

## 📋 必要な準備

- Googleアカウント
- [Google Gemini API Key](https://aistudio.google.com/app/apikey)
- Google Sheets（下記テンプレートから複製）
- Node.js（開発環境用）
- [@google/clasp](https://github.com/google/clasp) CLI ツール

## 🚀 セットアップ手順

### 1. スプレッドシートの準備

参照用スプレッドシート（テンプレート）をコピーしてください：

📊 **[テンプレートスプレッドシート](https://docs.google.com/spreadsheets/d/1u07YmP0w4yXzwEWKOfqrdiC-xu-_aGoGlMV9jBIdJJY/edit?usp=sharing)**

1. 上記リンクからスプレッドシートにアクセス
2. `ファイル` → `コピーを作成` でコピー
3. コピーしたスプレッドシートのIDをメモ（URLの`/d/`と`/edit`の間の部分）

### 2. Google Apps Scriptプロジェクトの作成

```bash
# claspのインストール
npm install -g @google/clasp

# Googleアカウントでログイン
clasp login

# プロジェクトをクローン
git clone [このリポジトリ]
cd gemini-chat-bot20250910

# Apps Scriptプロジェクトを作成
clasp create --type webapp --title "Gemini Chatbot"
```

### 3. コードのデプロイ

```bash
# コードをGoogle Apps Scriptにプッシュ
clasp push

# Apps Scriptエディタを開く
clasp open
```

### 4. 設定の構成

#### API Keyの設定
Apps Scriptエディタで：
1. `プロジェクトの設定` → `スクリプトプロパティ`
2. プロパティを追加：
   - プロパティ名: `apikey`
   - 値: [あなたのGemini API Key]

#### スプレッドシートの連携
1. Apps Scriptエディタで`コード.js`を開く
2. 8行目付近の`SPREADSHEET_ID`を更新：
   ```javascript
   const SPREADSHEET_ID = 'あなたのスプレッドシートID';
   ```
3. 実行 → `onOpen`関数を実行（初期化）

### 5. Webアプリとしてデプロイ

```bash
# デプロイ
clasp deploy --description "初期デプロイ"

# または、Apps Scriptエディタから：
# デプロイ → 新しいデプロイ → ウェブアプリ
# 実行ユーザー: 自分
# アクセス: 全員（匿名ユーザーを含む）
```

## 📝 スプレッドシートの構成

### シート構成
- **プロンプト**: システムプロンプト設定（A1セル）
- **ログ**: 会話履歴の自動記録（タイムスタンプ、ユーザーID、役割、メッセージ、トークン数）
- **設定**: UIカスタマイズと動作設定

### 設定可能な項目
| カテゴリ | 項目 | 選択肢 | デフォルト |
|----------|------|--------|------------|
| **外観** | テーマ | default, dark, sunset, forest, ocean, lavender, midnight, sakura, custom | default |
| | 文字サイズ | small, medium, large, xlarge | medium |
| **動作** | タイピングインジケーター | true/false | true |
| | 通知音 | true/false | false |
| | 自動スクロール | true/false | true |
| | 送信ショートカット | Enter/Ctrl+Enter | Enter |
| **高度な設定** | メッセージ削除可能 | true/false | false |
| | 最大履歴表示数 | 10-200 | 50 |

## 🔧 管理メニュー機能

スプレッドシートのメニューから以下の管理機能にアクセスできます：

### 📊 データ・統計
- **統計情報を表示**: 詳細な使用統計とメトリクス
- **アクティブユーザーを表示**: 現在のアクティブユーザー一覧
- **パフォーマンス指標を表示**: システムパフォーマンスの詳細分析

### 🔧 システム管理
- **システムヘルスチェック**: 総合的なシステム状態診断
- **キャッシュをクリア**: 全ての会話履歴キャッシュをリセット
- **セッション一覧**: 全ユーザーセッションの管理
- **セッションクリーンアップ**: 期限切れセッションの自動削除

### 📤 エクスポート・インポート
- **ログをエクスポート**: 会話ログのCSV/JSON/TXT形式エクスポート
- **セッションをエクスポート**: セッションデータのバックアップ作成
- **セッションをインポート**: バックアップからの復元

### ⚙️ 設定管理
- **設定シートを初期化**: 全設定を工場出荷時状態に戻す
- **履歴復元**: ログシートからの会話履歴復元

## 🏗️ 技術アーキテクチャ

### 3層ストレージシステム
```
メモリバッファ (logBuffer)
    ↓ バッチ処理 (10件ごと)
キャッシュサービス (6時間TTL)
    ↓ 永続化
Google Sheets / PropertiesService
```

### パフォーマンス最適化
- **インテリジェントキャッシュ**: プロンプト（1時間）、設定（10分）
- **バッチ処理**: ログ記録の効率的な一括処理
- **並行制御**: 最大5件の同時リクエスト制限
- **自動リトライ**: 指数バックオフ（最大3回）

### セッション管理
```javascript
class SessionManager {
  - createSession()     // 新規セッション作成
  - updateSession()     // セッション状態更新  
  - exportSession()     // セッションデータ出力
  - importSession()     // セッションデータ復元
  - cleanupTimedOutSessions() // 期限切れセッション削除
}
```

## 📊 技術仕様

| 項目 | 仕様 |
|------|------|
| **AIモデル** | Gemini 2.5 Flash |
| **最大出力トークン** | 8,192 |
| **Temperature** | 0.3 |
| **キャッシュ期間** | 6時間 |
| **会話履歴** | 最大10メッセージ |
| **バッチサイズ** | 10件/バッチ |
| **同時リクエスト** | 最大5件 |
| **セッション保持** | 1時間（自動延長） |
| **リトライ回数** | 最大3回（指数バックオフ） |

## 🛠️ 開発コマンド

```bash
# 変更をプッシュ
clasp push

# 強制プッシュ（変更が検出されない場合）
clasp push --force

# ログを確認
clasp logs

# 監視モード（自動プッシュ）
clasp push --watch

# バージョン作成
clasp version "バージョン説明"

# 新しいデプロイ作成
clasp deploy --versionNumber [version] --description "デプロイ説明"
```

## 📁 プロジェクト構成

```
gemini-chat-bot20250910/
├── コード.js              # メインサーバーサイドロジック
│   ├── CONFIG             # アプリケーション設定
│   ├── SessionManager     # セッション管理クラス  
│   ├── API Functions      # Gemini API統合
│   ├── Cache Functions    # キャッシュ管理
│   ├── Log Functions      # ログ記録システム
│   ├── Menu Functions     # 管理メニュー
│   └── Settings Functions # 設定管理
├── index.html             # メインUI（LINE風チャット画面）
├── script.html            # クライアントサイドJavaScript
├── style.css.html         # スタイルシート（テーマ、レスポンシブ）
├── appsscript.json        # Apps Script設定ファイル
├── .clasp.json           # CLASPプロジェクト設定
├── CLAUDE.md             # Claude Code開発ガイド
└── README.md             # プロジェクト説明書（このファイル）
```

## 🔒 セキュリティ

### 認証・認可
- **API Key管理**: スクリプトプロパティによる安全な保存
- **匿名アクセス**: 認証不要でのアクセス可能
- **実行権限**: デプロイユーザーとしての実行

### データ保護
- **エラー情報**: 技術詳細を隠した日本語エラーメッセージ
- **ログ管理**: タイムスタンプ付き詳細ログ記録
- **データ整合性**: 自動バックアップと復元機能

## 🚨 トラブルシューティング

### よくある問題と解決方法

#### 1. ログが保存されない
```
原因: Google Apps Scriptの制限により setTimeout が使用不可
解決: 手動フラッシュ機能で即座にログを保存
対策: processMessage内でflushLogBuffer()を呼び出し
```

#### 2. API呼び出しがタイムアウトする
```
原因: ネットワーク遅延またはレート制限
解決: 自動リトライ機構で回復
対策: 指数バックオフで再試行間隔を調整
```

#### 3. 設定が保存されない
```
原因: スプレッドシートのアクセス権限不足
解決: 設定シートの初期化で修復
対策: メニュー > 設定シートを初期化
```

#### 4. チャット履歴が消失する
```
原因: キャッシュサービスの期限切れ
解決: ログシートからの自動復元
対策: メニュー > 履歴復元機能を使用
```

### デバッグ手順
1. **Apps Scriptエディタ**: 実行ログでエラー詳細を確認
2. **スプレッドシート**: ログシートで会話履歴を確認
3. **ブラウザコンソール**: クライアントサイドエラーを確認
4. **システムヘルスチェック**: メニューから総合診断を実行

## ⚡ パフォーマンス最適化

### 推奨設定
- **バッチログ**: 有効（10件/バッチ）
- **キャッシュ**: プロンプト・設定キャッシュ有効
- **並行制御**: 最大5リクエスト/同時
- **パフォーマンス監視**: 有効

### 監視指標
- API呼び出し回数とレスポンス時間
- キャッシュヒット率/ミス率  
- メモリ使用量とバッファサイズ
- エラー率とリトライ成功率

## 📝 ライセンス

このプロジェクトは個人使用を目的としています。商用利用の際は以下の利用規約をご確認ください：
- [Google Gemini API利用規約](https://ai.google.dev/terms)
- [Google Apps Script利用規約](https://script.google.com/home)

## 🤝 貢献

プロジェクトへの貢献を歓迎します：

1. **Issues**: バグ報告や機能要望はIssueにて
2. **Pull Requests**: 大きな変更前にはIssueで議論を
3. **コードスタイル**: JSDoc、日本語コメント、camelCase命名
4. **テスト**: 変更後は必ずApps Scriptエディタでテスト実行

## 📞 サポート

問題が発生した場合の対処手順：

### 🔍 **Step 1: 基本確認**
1. API Keyが正しく設定されているか確認
2. スプレッドシートのアクセス権限を確認
3. ブラウザキャッシュをクリア

### 🛠️ **Step 2: システム診断**
1. メニュー > システムヘルスチェックを実行
2. Apps Scriptエディタの実行ログを確認
3. スプレッドシートのログシートを確認

### 🚑 **Step 3: 復旧処理**
1. メニュー > キャッシュをクリア
2. メニュー > 履歴復元（必要に応じて）
3. メニュー > 設定シートを初期化（最終手段）

### 📧 **Step 4: サポート連絡**
上記で解決しない場合はIssueにて詳細をご報告ください：
- エラーメッセージの全文
- 操作手順の詳細
- ブラウザとOSの情報
- スクリーンショット（可能であれば）

---

🚀 **Built with ❤️ using Google Apps Script and Gemini AI**

*最終更新: 2025年9月8日*